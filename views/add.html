{% extends "article-layout.html" %} {% block list %}
<div class="list-head">
	<div>
		<i class="fa fa-list"></i>&nbsp;&nbsp;文章列表
	</div>
	<div>
		<a href="/postedit" style="color: #C0C0C0;"><i class="fa fa-plus"></i></a>
	</div>
</div>
<ul>
	{% for content in contents %}
	<a href="/postedit?contentid={{content.id.toString()}}">
		<li style="border-bottom: 1px solid #F0F0F0; overflow-x: hidden;" id="{{content._id.toString()}}">
			<h4 style="color: #42B983; margin: 0;">
				{% if content.isPublic == false %}
				<small style="color: red;">[草稿]</small>
				{% endif %}
				{{content.title}}
			</h4>
			<p style="margin: 0; color: #D5D5D5;">{{content.date}}</p>
		</li>
	</a>
	{% endfor %}
</ul>
{% endblock %} {% block main %}
<link rel="stylesheet" type="text/css" href="../static/css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="../static/css/font-awesome/css/font-awesome.css" />
<link rel="stylesheet" type="text/css" href="../static/css/custom_up_img.css" />
<link rel="stylesheet" type="text/css" href="../static/css/sweetalert.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<link rel="stylesheet" type="text/css" href="../static/css/add.css" />
<script src="../static/js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script src="../static/js/custom_up_img.js" type="text/javascript" charset="utf-8"></script>
<script src="../static/js/cropper.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../static/js/sweetalert-dev.js" type="text/javascript" charset="utf-8"></script>
<div class="container-view">
	<div class="row-view">
		<form method="post">
			<div class="content-head">
				<input type="text" name="title" placeholder="新建文章" value="{{content.title}}" />
			</div>
			<div class="content-tag">
				<div class="myTags">
					<i class="fa fa-tags"></i>
					<a href="" style="color: #42B983;"><i class="fa fa-plus"></i></a>
				</div>
				<div class="submitBtn">
					{% if content %}
					<input id="deleteArticle" class="btn btn-default" style="width: 82px;" value="删除文章">
					<input id="saveArticle" class="btn" style="background: #42B983; color: #FFF;width: 82px;" value="保存修改"/>
					{% if content.isPublic != true %}
					<input id="postDraft" class="btn btn-default" style="background: #42B983; color: #FFF;width: 82px;" value="发布文章" />
					{% endif %} 
					{% else %}
					<input id="saveDraft" class="btn btn-default" style="width: 82px;" value="保存草稿">
					<button type="submit" class="btn" style="background: #42B983; color: #FFF;">发布文章</button> 
					{% endif %}
				</div>
			</div>
			<textarea id="article-content" name="content">{{content.content}}</textarea>
			<br />
			<input type="hidden" name="coverImage" id="coverImage" value="" />
		</form>
	</div>
</div>
</div>
<script type="text/javascript">
	$('.con-list').eq(0).addClass('con-list-active');
	$(function(){
		getActive();
	})
//	getActive();
	function getActive(){
		var contentid = GetQueryString('contentid');
		console.log(contentid);
		$(`#${contentid}`).addClass('active-content');
	}
	var simplemde = new SimpleMDE({
		element: document.getElementById('article-content'),
		placeholder: '输入正文...'
	});
	// save draft
	$('#saveDraft').click(function() {
		var title = $('input[name=title]').val();
		var content = simplemde.value();
		if(title == '') {
			title = '新建文章';
		}
		$.ajax({
			type: "post",
			url: "/saveDraft",
			data: {
				title: title,
				content: content
			},
			dataType: 'json',
			success: function(data) {
				console.log(data);
				var res = eval(data);
				location.href = `/postedit?contentid=${res.newContent._id.toString()}`;
			}
		});
	});
	// delete article
	$('#deleteArticle').click(function() {
		var id = GetQueryString('contentid');
		console.log(id);
		$.ajax({
			type: "post",
			url: "/deleteArticle",
			data: {
				contentid: id
			},
			dataType: 'json',
			success: function(data) {
				console.log(data);
				location.href = `/postedit`;
			}
		});
	});
	// save article
	$('#saveArticle').click(function() {
		var id = GetQueryString('contentid');
		console.log(id);
		$.ajax({
			type: "post",
			url: "/saveArticle",
			data: {
				contentid: id,
				title:$('input[name=title]').val(),
				content:simplemde.value()
			},
			dataType: 'json',
			success: function(data) {
				console.log(data);
				location.href = `/postedit?contentid=${id}`;
			}
		});
	});
	// post draft
	$('#postDraft').click(function() {
		var id = GetQueryString('contentid');
		console.log(id);
		$.ajax({
			type: "post",
			url: "/postDraft",
			data: {
				contentid: id,
				title:$('input[name=title]').val(),
				content:simplemde.value()
			},
			dataType: 'json',
			success: function(data) {
				console.log(data);
				location.href = `/postedit?contentid=${id}`;
			}
		});
	});
	
	
	//	$('#coverBtn').click(function() {
	//		var img = $('#cover').get(0).files[0];
	//		if(!/image\/\w+/.test(img.type)) {
	//			alert("请确保文件为图像类型");
	//			return false;
	//		}
	//		var reader = new FileReader();
	//		reader.onload = function(e) {
	//			//			console.log(e.target.result);
	//			$.ajax({
	//				type: "post",
	//				url: "/uploadImage",
	//				data: {
	//					type: 'coverimg',
	//					data: e.target.result.toString()
	//				},
	//				dataType: 'json',
	//				success: function(data) {
	//					if(data.result == 'ok') {
	//						alert('上传成功');
	//						$('#coverImage').val(data.image);
	//					}
	//				}
	//			});
	//		}
	//		reader.readAsDataURL(img);
	//	});
</script>
{% endblock %}